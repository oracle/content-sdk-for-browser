/**
 * Copyright (c) 2019 Oracle and/or its affiliates. All rights reserved.
 * Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
 */
!function(e,t){"function"==typeof define&&define.amd?define(["exports"],t):"object"==typeof exports&&exports&&"string"!=typeof exports.nodeName?t(exports):(e.contentSDK={},t(e.contentSDK))}(this,function(e){"use strict";var t={bind:function(e,t){return function(){return e.apply(t,arguments)}},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}},n=function(){var e={logLevel:"none",logLevels:["error","warn","info","debug","log"]},n=function(e){};return e.updateLogger=function(o){if(o)for(var r=0;r<this.logLevels.length;r++){var s=e.logLevels[r];e[s]="function"==typeof o[s]?t.bind(o[s],o):n}},e.updateLogger({}),e}(),o={requirePaths:{},getContentLayoutRequirePath:function(e){var t=e.contentServer,n="object"==typeof e.cacheBuster?e.cacheBuster:{layoutKey:e.cacheBuster,systemKey:e.cacheBuster},o=n.layoutKey?"/"+n.layoutKey:"",r=n.systemKey?"/"+n.systemKey:"";if(!this.requirePaths[t]){var s="contentLayoutPath"+Math.floor(1e8+9e8*Math.random()),i={};i[s+"published"]=t+"/_compdelivery"+o,i[s+"draft"]=t+"/_themes/_components"+o,i[s+"system"]=t+"/_sitescloud"+r+"/sitebuilder/contentlayouts",this.requirePaths[t]=s,requirejs.config({paths:i})}return this.requirePaths[t]},preloadContentLayout:function(e,t,o){require([e],function(e){t()},function(t){n.warn("ContentClient.renderLayout: Unable to render the layout.  Ensure you can access the layout: If running against published content, that the layout has been published. If draft, that you are logged onto the Sites server"),o("Failed to get layout: "+e+" with error: "+t)})},renderContentLayout:function(e,t,o,r,s){require([e],function(e){var n=new e(t).render(o);"object"==typeof n&&"function"==typeof n.then?n.then(function(e){r()},function(e){s(e)}):r()},function(t){n.warn("ContentClient.renderLayout: Unable to render the layout.  Ensure you can access the layout: If published, that the layout has been published. If draft, that you are logged onto the Sites server"),s("failed to get layout: "+e+" with error: "+t)})}},r=function(){};r.prototype={type:"Node",extractServer:function(e){var t=require("url"),n=e||"http://localhost",o=t.parse(n);return o.protocol+"//"+o.hostname+(o.port?":"+o.port:"")},callRestServer:function(e,t){n.debug("_rest.callRestServer: Calling "+t.method+" request with:"),n.debug(e),n.debug(t);var o={"http:":require("http"),"https:":require("https")},r=require("url");require("querystring");return new Promise(function(n,s){var i,a=r.parse(e),u=o[a.protocol||"https:"],c=function(e){try{return"function"==typeof t.beforeSend&&t.beforeSend(e),!0}catch(e){s({status:e,statusText:"Error in beforeSend() callback"})}return!1},p=function(e){var t="",o=e.statusCode;e.on("data",function(e){t+=e}),e.on("end",function(){if(o>=200&&o<300)try{var r=JSON.parse(t);n(r)}catch(e){s({error:t})}else s(e)})};if(a.method=t.method.toUpperCase()||"","GET"===a.method&&e)c(a)&&(i=u.get(a,p));else if("POST"===a.method&&t.noCSRFToken&&t.postData){var l=JSON.stringify(t.postData);a.headers={"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","Content-Length":l.length},c(a)&&(i=u.request(a,p).write(l))}else s({error:"unsupported REST request: "+JSON.stringify(t)});i&&(i.on("error",function(e){s({error:e})}),i.on("socket",function(e){e.setTimeout(t.timeout),e.on("timeout",function(){s({error:"request timed out after: "+t.timeout})})}))})}};var s=function(){};s.prototype={type:"Browser",extractServer:function(e){var t=e||window.location&&window.location.href,n=document.createElement("a");return n.href=t,n.protocol+"//"+n.hostname+(n.port?":"+n.port:"")},callRestServer:function(e,t){return n.debug("_rest.callRestServer: Calling "+t.method+" request with:"),n.debug(t),new Promise(function(o,r){var s=new XMLHttpRequest,i={method:t.method&&t.method.toUpperCase()||"",url:e,headers:{Authorization:t.authorization||"anonymous"},timeout:t.timeout},a=!0;if("GET"===i.method&&i.url||("POST"===i.method&&i.url&&t.noCSRFToken&&t.postData?(i.headers["Content-Type"]="application/json; charset=UTF-8",i.headers["X-Requested-With"]="XMLHttpRequest",i.data=t.postData):-1!==["POST","PUT"].indexOf(i.method)&&i.url&&t.postData?(i.headers["Content-Type"]="application/json; charset=UTF-8",i.headers["X-Requested-With"]="XMLHttpRequest",i.headers["X-CSRF-Token"]=this.getCSRFToken(i.url),i.data=t.postData):"DELETE"===i.method&&i.url?i.headers["X-CSRF-Token"]=this.getCSRFToken(i.url):(n.error("_rest.callRestServer: invalid arguments:"),n.error(t),r({status:400,statusText:'Expected to see arguments: { "method": "GET/POST/PUT/DELETE", "url": url } but recieved: '+JSON.stringify(t)}),a=!1)),a){s.onload=function(){this.status>=200&&this.status<300?o(JSON.parse(s.response?s.response:s.responseText)):r({status:this.status,statusText:s.statusText})},s.onerror=function(){r({status:this.status,statusText:s.statusText})},s.ontimeout=function(){r({status:this.status,statusText:s.statusText})},s.open(i.method,i.url);for(var u in i.headers)i.headers.hasOwnProperty(u)&&s.setRequestHeader(u,i.headers[u]);s.timeout=i.timeout,function(e){try{return"function"==typeof t.beforeSend&&t.beforeSend(e),!0}catch(e){r({status:e,statusText:"Error in beforeSend() callback"})}return!1}(s)&&(i.data?s.send(JSON.stringify(i.data)):s.send())}})}};var i=function(){};(i.prototype=Object.create(s.prototype)).contextRoot="/content",i.prototype.defaultVersion="v1",i.prototype.supportedVersions=[{semanticVersion:"1.0.0",contentVersion:"v1"},{semanticVersion:"1.1.0",contentVersion:"v1.1"}],i.prototype.getContentVersion=function(e,t){for(var o=/\s*((([<>]?=?)\s*(v)?([0-9]+)(\.([0-9]+))?(\.([0-9]+))?))\s*/g.exec(t||"0.0.0")||[],r=(o[5]||"0")+"."+(o[7]||"0")+"."+(o[9]||"0"),s=0;s<this.supportedVersions.length;s++)if(this.supportedVersions[s].semanticVersion===r)return this.supportedVersions[s].contentVersion;return n.warn('Content SDK: "'+e+'" has unrecognized Content Version: "'+t+'" - defaulting to: version="'+this.defaultVersion+'". To avoid this message, use one of the supported versions when creating a content client: '+JSON.stringify(this.sOupportedVersions)),this.defaultVersion},i.prototype.state={published:"published",draft:"management"},i.prototype.getCSRFToken=function(e){return"CSRFToken"},i.prototype.createPrefix=function(e){return e.contentServer+this.contextRoot+"/"+this.state[e.contentType]+"/api/"+this.contentVersion},i.prototype.createSuffix=function(e){var t=e.search||"",n=e.channelToken?this.properties.tokenName+"="+e.channelToken:"",o="object"==typeof e.cacheBuster?e.cacheBuster.contentKey:e.cacheBuster,r=o?"cb="+o:"",s="";return s+=t,s+=(s&&n?"&":"")+n,s+=(s&&r?"&":"")+r},i.prototype.formatURL=function(e,t){var o=this.createPrefix(t),r=this.createSuffix(t),s=o+e+(r?(-1===e.indexOf("?")?"?":"&")+r:"");return n.info(s),s},i.prototype.resolveGetTypesPath=function(e){return"/types"},i.prototype.resolveGetTypePath=function(e){return"/types/"+e.typeName},i.prototype.makeGetFolderMetadataURL=function(e){var t=e.contentServer+"/documents/web?IdcService=GET_METADATA&suppressHttpErrorCodes=1&items=fFolderGUID:"+e.folderGUID.join(",");return n.info(t),t},i.prototype.getLayouts=function(e,n){var o=this,r=o.formatURL(o.resolveGetTypesAggregatePath({types:e||[]}),n);return new Promise(function(e,s){o.callRestServer(r,n).then(t.bind(function(r){var i,a={};r.externalFile?(a[r.externalFile.folderId]=r.name,i=o.makeGetFolderMetadataURL({contentServer:n.contentServer,folderGUID:[r.externalFile.folderId]}),o.callRestServer(i,n).then(t.bind(function(t){var n,o,r,i,u,c=t&&t.ResultSets&&t.ResultSets.xCaasTypeCategoryLayoutMappingCollection,p={};if(c){i=c.fields,u=c.rows;for(var l=0;l<i.length;l++)"xCaasCategoryName"===i[l].name?n=l:"xCaasLayoutName"===i[l].name?o=l:"dParentMetadataUnitID"===i[l].name&&(r=l);u.forEach(function(e){var t=a[e[r]];p[t]||(p[t]={}),p[t][e[n]]=e[o]}),e(p)}else s(t.LocalData.StatusMessage)},o),function(e,t){s(t)})):e(void 0)},o),function(e,t){s(t)})})},i.prototype.isDigitalAsset=function(e){return/^DigitalAsset_/i.test(e)||36===e.length&&(/^CONT/.test(e)||/^CORE/.test(e))},i.prototype.getRenditionURL=function(e,t,o){var r="";if(e)if(this.isDigitalAsset(e)){var s,i,a=o.format,u="object"==typeof o.cacheBuster?o.cacheBuster.contentKey:o.cacheBuster,c="?";i=o.secureContent?this.properties.secureAssetURLName:this.properties.assetURLName,s=t||this.properties.digitalAssetDefault,r=this.createPrefix(o)+"/"+i+"/"+e+"/"+s,u&&(r+=c+"cb="+u,c="&"),a&&(r+=c+"format="+a,c="&"),"published"===o.contentType&&o.channelToken&&(r+=c+this.properties.tokenName+"="+o.channelToken,c="&")}else r=o.contentServer+"/documents/file/"+e;return n.info(r),r},i.prototype.makeQueryParameters=function(e){var n=t.extend({},e),o={postData:{},getData:""},r="",s=n.search;if(delete n.ids,delete n.IDs,delete n.id,delete n.ID,delete n.itemGUID,delete n.itemGUIDs,delete n.timeout,delete n.search,delete n.types,delete n.beforeSend,delete n.contentType,delete n.language,JSON.stringify(n).length>1800)o.method="POST",o.postData=n;else{var i="";for(var a in n)if(n.hasOwnProperty(a)&&a===encodeURI(a)){var u=n[a];if("orderBy"===a&&Array.isArray(u)&&1===u.length){var c=u[0].order&&u[0].order.toLowerCase()||"",p=c?":"+("des"===c?"desc":c):"";u=u[0].name+p}"object"!=typeof u&&(r+=i+a+"="+encodeURI(u),i="&")}r+=s?i+s:"",o.method="GET",o.getData=r,o.useAggregate=n.itemDepth||n.expand}return o};var a=function(){};(a.prototype=Object.create(i.prototype)).contentVersion="v1",a.prototype.properties={tokenName:"access-token",digitalAssetDefault:"default",assetURLName:"digital-assets",secureAssetURLName:"secure-digital-assets"},a.prototype.resolveGetItemListPath=function(e){return"/items"+(e.useAggregate?"/aggregate":"")+(e.types?"?field:type:equals="+e.types:"")},a.prototype.resolveGetItemPath=function(e){return"/items/"+e.itemGUID+(e.useAggregate?"/aggregate":"")},a.prototype.resolveSearchPath=function(e){return"/items/queries"},a.prototype.resolveGetTypesAggregatePath=function(e){return"/aggregates/types"+(e.types.length>0?"/"+e.types.join(","):"")},a.prototype.resolveGetBulkItemListPath=function(e){return"/items/bulk"+(e.useAggregate?"/aggregate":"")+"?ids="+e.itemGUIDs.join(",")};var u=function(){};(u.prototype=Object.create(a.prototype)).contentVersion="v1.1",u.prototype.properties={tokenName:"channelToken",digitalAssetDefault:"native",assetURLName:"assets",secureAssetURLName:"assets"},u.prototype.resolveGetItemListPath=function(e){var t="/items",n="?";return e.types&&(t+=n+"field:type:equals="+e.types,n="&"),e.useAggregate&&(t+=n+'expand="all"',n="&"),t},u.prototype.resolveGetItemPath=function(e){var t=e.language?"/variations/language/"+e.language+"?fields=all":"",n=t?"&":"?",o=e.useAggregate?n+"expand="+e.useAggregate:"";return"/items/"+e.itemGUID+t+o},u.prototype.resolveSearchPath=function(e){return"/items"},u.prototype.resolveGetTypesAggregatePath=function(e){return"/types"+(e.types.length>0?"/"+e.types.join(","):"")},u.prototype.resolveGetBulkItemListPath=function(e){var t='(id eq "'+e.itemGUIDs.join('" or id eq "')+'")',n=e.language?'(language eq "'+e.language+'")':"";return"/items?q="+(n?"("+t+" and "+n+")":t)};var c={createRestAPI:function(e){return"v1"===i.prototype.getContentVersion("ContentSDK create content client",e)?new a:new u}},p=function(e){this.restAPI=c.createRestAPI(e.contentVersion),n.updateLogger(e.logger),this.info={accessToken:e.channelToken||e.accessToken,channelToken:e.channelToken||e.accessToken,cacheBuster:e.cacheBuster,beforeSend:e.beforeSend,clientType:"delivery",contentServer:this.restAPI.extractServer(e.contentServer),contentType:"published",secureContent:e.secureContent||!1,timeout:e.timeout||0,contentVersion:this.restAPI.contentVersion},this.info.authorization=this.authorization||(this.info.secureContent?"session":"anonymous"),this.validContentTypes=["published"],this.validLayoutTypes=this.validContentTypes,this.publicSDK={getInfo:t.bind(this.getInfo,this),getItem:t.bind(this.getItem,this),getItems:t.bind(this.getItems,this),searchItems:t.bind(this.queryItems,this),queryItems:t.bind(this.queryItems,this),getRenditionURL:t.bind(this.getRenditionURL,this),getLayoutInfo:t.bind(this.getLayoutInfo,this),renderItem:t.bind(this.renderItem,this),expandMacros:t.bind(this.expandMacros,this)},n.debug("ContentClient.create: Content Info:"),n.debug(this.info)};p.prototype.resolveRESTArgs=function(e,n){var o=this.restAPI.makeQueryParameters(n),r=t.extend({},this.info);return r.method=e,r.contentType=this.getContentType(n.contentType),r.authorization=this.getInfo().authorization,r.language=n.language,r.beforeSend=n.beforeSend||r.beforeSend,r.timeout=n.timeout||r.timeout,r.postData=o.postData,r.useAggregate=o.useAggregate,r.search=o.getData,n.format&&(r.format=n.format),"GET"===r.method&&(r.method=o.method||r.method),r},p.prototype.getContentType=function(e){var t="string"==typeof e&&e.toLowerCase()||this.info.contentType;return-1!==this.validContentTypes.indexOf(t)?t:(n.warn("Invalid value for content type request: "+e+". Allowed values are: "+JSON.stringify(this.validContentTypes)+". Defaulting to: "+this.info.contentType),this.info.contentType)},p.prototype.getLayoutType=function(e){var t="string"==typeof e&&e.toLowerCase()||this.info.contentType;return-1!==this.validLayoutTypes.indexOf(t)?t:(n.warn("Invalid value for layout type request: "+e+". Allowed values are: "+JSON.stringify(this.validLayoutTypes)+". Defaulting to: "+this.info.contentType),this.info.contentType)},p.prototype.renderLayout=function(e,n,r,s,i,a){if(s)o.preloadContentLayout(e,i,a);else{var u=t.extend({},n);u.contentClient||(u.contentClient=this.publicSDK),o.renderContentLayout(e,u,r,i,a)}},p.prototype.getInfo=function(){return t.extend({},this.info)},p.prototype.getItem=function(e){var t=e||{},n=t.id||t.ID||t.itemGUID,o=this.resolveRESTArgs("GET",t),r=this.restAPI.formatURL(this.restAPI.resolveGetItemPath({itemGUID:n,useAggregate:o.useAggregate,language:e.language}),o);return this.restAPI.callRestServer(r,o)},p.prototype.getItems=function(e){var o,r=this,s=e||{},i=s.ids||s.IDs||s.itemGUIDs,a=r.resolveRESTArgs("GET",s);if(n.debug("ContentClient.getItems: arguments"),n.debug(s),Array.isArray(i)&&i.length>0){var u,c=i.length,p=[];return new Promise(function(e,n){for(var l=0;l<c;l+=10)u=i.slice(l,l+10),o=r.restAPI.formatURL(r.restAPI.resolveGetBulkItemListPath({itemGUIDs:u,types:s.types,useAggregate:a.useAggregate,language:a.language}),a),p.push(r.restAPI.callRestServer(o,a));Promise.all(p).then(function(n){var o={items:[]};"v1"===r.info.contentVersion?(o.items={},n.forEach(function(e){e&&e.items&&(o.items=t.extend(o.items,e.items))})):n.forEach(function(e){o.items=o.items.concat(e.items)}),e(o)},function(e){n(e)})})}return o=r.restAPI.formatURL(r.restAPI.resolveGetItemListPath({itemGUID:s.itemGUID,types:s.types,useAggregate:a.useAggregate}),a),r.restAPI.callRestServer(o,a)},p.prototype.queryItems=function(e){var t=this,o=e||{},r=this.resolveRESTArgs("GET",o);n.debug("ContentClient.queryItems: arguments"),n.debug(o),r.noCSRFToken=!0;var s=t.restAPI.formatURL(t.restAPI.resolveSearchPath(),r);return t.restAPI.callRestServer(s,r)},p.prototype.getRenditionURL=function(e){var t=this,n=e||{},o=n.id||n.ID||n.itemGUID,r=t.resolveRESTArgs("GET",n);return t.restAPI.getRenditionURL(o,n.type,r)},p.prototype.getLayoutInfo=function(e){var t,r,s=this,i=e||{},a=["system-default-layout","system-tile-layout"].indexOf(i.layout)>-1;return new Promise(function(e,u){if(i.layout){a?(t="system",r=i.layout):(t=s.getLayoutType(i.layoutType),r=i.layout+"/assets/render");var c=o.getContentLayoutRequirePath(s.info)+t+"/"+r;n.debug("ContentClient.getLayoutInfo: require path: "+c),require([c],function(o){var s=o.prototype.contentVersion;s||(n.warn('Content Layout: "'+i.layout+'" does not have a contentVersion specified. Assuming data needs to be fetched in "v1.0" format for this Content Layout.  To avoid this message, add the prototype.contentVersion property to the Content Layout Factory object.'),s="1.0.0"),e({name:i.layout,layoutFactory:r,layoutType:t,requirePath:c,contentVersion:s})})}else n.debug("ContentClient.getLayoutInfo: missing required parameters"),u("missing parameters in call to getLayoutInfo: "+JSON.stringify(i))})},p.prototype.renderItem=function(e){var t,r,s=this,i=e||{},a=["system-default-layout","system-tile-layout"].indexOf(i.layout)>-1;return new Promise(function(e,u){if(i.layout){a?(t="system",r=i.layout):(t=s.getLayoutType(i.layoutType),r=i.layout+"/assets/render");var c=o.getContentLayoutRequirePath(s.info)+t+"/"+r;n.debug("ContentClient.renderItem: require path: "+c),s.renderLayout(c,i.data,i.container,i.preloadLayout,e,u)}else n.debug("ContentClient.renderItem: missing required parameters"),u("missing parameters in call to renderLayout: "+JSON.stringify(i))})},p.prototype.expandMacros=function(e){var o=e||"";return n.log("expandMacros: beforeValue: "+e),[{name:"DIGITAL_ASSET",macro:/\[!--\$CEC_DIGITAL_ASSET--\]*(.*?) *\[\/!--\$CEC_DIGITAL_ASSET--\]/g,value:t.bind(function(e,t){return this.getRenditionURL({id:t})},this)},{name:"PAGE_LINK",macro:/\[!--\$SCS_PAGE--\]*(.*?) *\[\/!--\$SCS_PAGE--\]/g,value:t.bind(function(e,t){var n,o=window&&window.SCSRenderAPI||{};if("function"==typeof o.getPageLinkData){var r=o.getPageLinkData(t);n=r&&r.href}else"function"==typeof o.getPageLinkUrl&&(n=o.getPageLinkUrl(t));return n||"#"},this)}].forEach(function(e){o=o.replace(e.macro,e.value)}),n.log("expandMacros: afterValue: "+o),o};var l=function(e){this.restAPI=c.createRestAPI(e.contentVersion),n.updateLogger(e.logger),this.info={accessToken:e.channelToken||e.accessToken,channelToken:e.channelToken||e.accessToken,beforeSend:e.beforeSend,cacheBuster:e.cacheBuster,clientType:"preview",contentServer:this.restAPI.extractServer(e.contentServer),contentType:e.contentType&&"published"===e.contentType.toLowerCase()?"published":"draft",secureContent:e.secureContent||!1,timeout:e.timeout||0,contentVersion:this.restAPI.contentVersion},this.info.authorization=e.authorization||(this.info.secureContent?"session":"anonymous"),this.validContentTypes=["published","draft"],this.validLayoutTypes=this.validContentTypes,this.publicSDK={getInfo:t.bind(this.getInfo,this),getItem:t.bind(this.getItem,this),getItems:t.bind(this.getItems,this),searchItems:t.bind(this.queryItems,this),queryItems:t.bind(this.queryItems,this),getRenditionURL:t.bind(this.getRenditionURL,this),getLayoutInfo:t.bind(this.getLayoutInfo,this),renderItem:t.bind(this.renderItem,this),expandMacros:t.bind(this.expandMacros,this),getTypes:t.bind(this.getTypes,this),getType:t.bind(this.getType,this),getCategoryToLayoutMapping:t.bind(this.getCategoryToLayoutMapping,this)},n.debug("ContentClient.create: Content Info:"),n.debug(this.info)};(l.prototype=Object.create(p.prototype)).getTypes=function(e){var t=this,o=e||{},r=t.resolveRESTArgs("GET",o);n.debug("ContentClient.getTypes: arguments"),n.debug(o);var s=t.restAPI.formatURL(t.restAPI.resolveGetTypesPath(),r);return t.restAPI.callRestServer(s,r)},l.prototype.getType=function(e){var t=this,o=e||{},r=t.resolveRESTArgs("GET",o);n.debug("ContentClient.getType: arguments"),n.debug(o);var s=t.restAPI.formatURL(t.restAPI.resolveGetTypePath({typeName:o.typeName}),r);return t.restAPI.callRestServer(s,r)},l.prototype.getCategoryToLayoutMapping=function(e){var t=this,n=e||{},o=n.types||[],r=t.resolveRESTArgs("GET",n);return new Promise(function(e,n){t.restAPI.getLayouts(o,r).then(function(t){e(t)},function(e){n("Failed to retrieve layouts from the content server. Verify that you can connect to the content server. "+e)})})};return e.enableLogging=function(){console.info("ContentSDK - enableLogging function obsolete, pass logger into the content client")},e.userLogging=function(e){console.info("ContentSDK - userLogging function deprecated, pass logger into the content client"),n.updateLogger(e)},e.createDeliveryClient=function(e){var t=new p("object"==typeof e?e:{});return n.debug("ContentSDK.createDelivery: created new Content SDK client object:"),n.debug(t),t?t.publicSDK:void 0},e.createPreviewClient=function(e){var t=new l("object"==typeof e?e:{});return n.debug("ContentSDK.createPreviewClient: created new Content SDK client object:"),n.debug(t),t?t.publicSDK:void 0},e});
